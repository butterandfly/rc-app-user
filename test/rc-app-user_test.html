<!doctype html>

<html>
  <head>
    <title>rc-app-user test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../rc-app-user.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <rc-app-user id="user1"></rc-app-user>
        <rc-app-user id="user2"></rc-app-user>
      </template>
    </test-fixture>

    <script>
      suite('rc-app-user', function() {
        'use strict'

        var user1, user2;

        function timePasses(ms) {
          return new Promise(function(resolve) {
            window.setTimeout(function() {
              resolve();
            }, ms);
          });
        }

        setup(function() {
          document.querySelector('#basic').create();
          user1 = document.querySelector('#user1');
          user2 = document.querySelector('#user2');
        });

        teardown(function() {
          sessionStorage.clear();
        });

        test('所有rc-app-user组件的同步', function() {
          let userData = {username: 'test'};
          user1.setUser(userData);

          assert.equal(user1.userCopy.username, 'test');
          return timePasses(1000).then(function() {
            assert.equal(user2.userCopy.username, 'test');
          });
        });

        test('设置app-localstorage-document', function() {
          let appUserStorage =  user1.querySelector('[key="rcAppUser"]');
          let appHistoryUserStorage =  user1.querySelector('[key="rcAppHistoryUser"]');

          let userData = {username: 'somename'};
          user1.setUser(userData);
          user1.setHistoryUser(userData);

          assert.equal(appUserStorage.data, userData);
          assert.equal(appHistoryUserStorage.data, userData);
        });

        test('设置与获取historyUser', function() {
          let userData = {username: 'test'};
          user1.setHistoryUser(userData);

          let historyUser = user1.getHistoryUser();
          assert.equal(historyUser.username, 'test');
        });

        test('isLogin属性', function() {
          assert.equal(user1.isLogin, false);

          let userData = {username: 'test'};
          user1.setUser(userData);

          assert.equal(user1.isLogin, true);

          user1.resetUser();

          assert.equal(user1.isLogin, false);
        });

      });
    </script>
  </body>
</html>
